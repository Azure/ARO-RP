name: "Test coverage"
on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

permissions:
  id-token: write
  contents: read

jobs:
  unit_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install tools (gotestsum)
        run: make install-tools

      - name: Run unit tests
        run: make unit-test-go

        # TODO: remove debug step
      - name: Debug - Check cover.out exists
        if: always()
        run: |
          echo "Current directory:"
          pwd
          echo "Looking for cover.out:"
          ls -la cover* 2>/dev/null || echo "cover.out not found"
          echo "First 10 lines of cover.out (if exists):"
          head -10 cover.out 2>/dev/null || echo "Cannot read cover.out"

      - name: Coveralls
        uses: coverallsapp/github-action@v2
        with:
          parallel: true
          flag-name: run-1
          format: golang
          file: cover.out

  finish:
    needs: [unit_tests]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Coveralls Finished
        uses: coverallsapp/github-action@v2
        with:
          parallel-finished: true
          carryforward: "run-1"
