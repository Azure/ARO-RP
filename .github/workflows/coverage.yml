name: CI Coverage

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: write # REQUIRED: To push the badge to the orphan branch
  pull-requests: write # REQUIRED: To comment on the PR

jobs:
  coverage:
    runs-on: ubuntu-latest
    env:
      LOCAL_ARO_RP_IMAGE: aro
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Important for git operations

      - name: Calculate Version
        id: vars
        run: |
          COMMIT=$(git rev-parse --short=7 HEAD)
          echo "VERSION=$COMMIT" >> $GITHUB_ENV

      - name: Run CI Build & Test
        run: make ci-rp

      - name: Extract Cover Profile
        run: |
          docker create --name extract_raw_cover ${{ env.LOCAL_ARO_RP_IMAGE }}:${{ env.VERSION }}
          docker cp extract_raw_cover:/app/cover.out ./cover.out
          docker rm extract_raw_cover

      - name: Calculate Total Coverage
        id: calc_cov
        run: |
          TOTAL_COVERAGE=$(go tool cover -func=cover.out | grep total | grep -oE '[0-9]+\.[0-9]+')
          echo "TOTAL_COVERAGE=$TOTAL_COVERAGE" >> $GITHUB_ENV

      - name: Check Coverage Delta (PR Only)
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          # Fetch existing badge from the 'badges' branch
          # We use curl with || echo 0 to handle 404s if branch/file doesn't exist
          OLD_BADGE=$(curl -s https://raw.githubusercontent.com/${{ github.repository }}/badges/coverage.svg || echo "")
          OLD_COVERAGE=$(echo "$OLD_BADGE" | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "0")

          # Compare using bc
          if (( $(echo "${{ env.TOTAL_COVERAGE }} < $OLD_COVERAGE" | bc -l) )); then
            echo "STATUS_MSG=⚠️ Coverage **decreased** from $OLD_COVERAGE% to ${{ env.TOTAL_COVERAGE }}%" >> $GITHUB_ENV
          elif (( $(echo "${{ env.TOTAL_COVERAGE }} > $OLD_COVERAGE" | bc -l) )); then
            echo "STATUS_MSG=✅ Coverage **increased** from $OLD_COVERAGE% to ${{ env.TOTAL_COVERAGE }}%" >> $GITHUB_ENV
          else
            echo "STATUS_MSG=Coverage remained stable at ${{ env.TOTAL_COVERAGE }}%" >> $GITHUB_ENV
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.STATUS_MSG
            })

      - name: Generate Badge File
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          # Use our new bash script to generate the SVG
          chmod +x hack/gen-badge.sh
          ./hack/gen-badge.sh ${{ env.TOTAL_COVERAGE }} > coverage.svg

      - name: Push Badge to Orphan Branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          # 1. Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 2. Stash the generated badge so it survives the checkout
          cp coverage.svg /tmp/coverage.svg

          # 3. Checkout 'badges' branch (create if doesn't exist)
          git fetch origin badges || true
          git checkout badges || git checkout --orphan badges

          # 4. Copy the badge back
          cp /tmp/coverage.svg coverage.svg

          # 5. Commit and Push ONLY if changed
          if [[ -n $(git status --porcelain coverage.svg) ]]; then
            git add coverage.svg
            git commit -m "Update coverage badge: ${{ env.TOTAL_COVERAGE }}%"
            git push origin badges
          else
            echo "No change in coverage, skipping push."
          fi
