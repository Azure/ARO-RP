---
- name: delete_aro_cluster | Check if cluster already exists
  ansible.builtin.command:
    argv:
      ["az", "aro", "show", "--name={{ name }}", "--resource-group={{ resource_group }}", "-o=yaml"]
  delegate_to: localhost
  register: aro_existing_cluster
  ignore_errors: true
  changed_when: false
- name: delete_aro_cluster | Set fact aro_cluster
  when: aro_existing_cluster is success
  ansible.builtin.set_fact:
    aro_cluster_state: "{{ aro_existing_cluster.stdout | from_yaml }}"
- name: delete_aro_cluster | Delete aro cluster
  azure.azcollection.azure_rm_openshiftmanagedcluster:
    name: "{{ name }}"
    resource_group: "{{ resource_group }}"
    location: "{{ location }}"
    state: absent
  delegate_to: localhost

- name: delete_aro_cluster | Delete service principal and app
  when: aro_cluster_state is defined
    and aro_cluster_state.servicePrincipalProfile.clientId is defined
  block:
    - name: delete_aro_cluster | Get service principal
      ansible.builtin.command:
        argv:
          - "az"
          - "ad"
          - "sp"
          - "show"
          - "--id={{ aro_cluster_state.servicePrincipalProfile.clientId }}"
          - "-o=yaml"
      delegate_to: localhost
      register: aro_ad_sp_output
      changed_when: false
    - name: delete_aro_cluster | Set fact aro_ad_sp_info
      when: aro_ad_sp_output is success
      ansible.builtin.set_fact:
        aro_ad_sp_info: "{{ aro_ad_sp_output.stdout | from_yaml }}"
    - name: delete_aro_cluster | Debug aro_ad_sp_info
      ansible.builtin.debug:
        var: aro_ad_sp_info
      tags:
        - verbose
    - name: delete_aro_cluster | Delete service principal
      ansible.builtin.command:
        argv:
          - az
          - ad
          - sp
          - delete
          - --id={{ aro_ad_sp_info.id }}
      register: delete_sp
      changed_when: delete_sp.rc == 0
      # azure.azcollection.azure_rm_adserviceprincipal:
      #   app_id: "{{ aro_ad_sp_info.id }}"
      #   state: absent
      delegate_to: localhost
    - name: delete_aro_cluster | Delete ad application
      ansible.builtin.command:
        argv:
          - az
          - ad
          - app
          - delete
          - --id={{ aro_ad_sp_info.appId }}
      register: delete_app
      changed_when: delete_app.rc == 0
      # azure.azcollection.azure_rm_adapplication:
      #   app_id: "{{ aro_ad_sp_info.appId }}"
      #   state: absent
      delegate_to: localhost
