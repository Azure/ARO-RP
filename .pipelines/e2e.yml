trigger: none
pr: none

resources:
  pipelines:
    - pipeline: e2e
      source: \Public Cloud ARO pipelines\CI\CI
      trigger: true
  containers:
    - container: container
      image: registry.access.redhat.com/ubi8/toolbox:8.8
      options: --user=0 --privileged -v /dev/shm:/dev/shm --device /dev/net/tun --name vpn

# Azure DevOps Pipeline running e2e tests
variables:
  - template: vars.yml

# Run the test suite and collect must-gather
jobs:
  - job: E2E
    timeoutInMinutes: 180
    variables:
      ARO_PODMAN_SOCKET: "tcp://localhost:8888"
      ARO_SELENIUM_HOSTNAME: "localhost"
    pool:
      name: 1es-aro-ci-pool
    steps:
      - template: ./templates/template-checkout.yml

      - script: |
          set -xe
          sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
          sudo dnf install -y openvpn make podman jq conmon containers-common crun iptables netavark nftables slirp4netns
        displayName: Setup (Container)
        target: container

      - template: ./templates/template-az-cli-login.yml
        parameters:
          azureDevOpsJSONSPN: $(aro-v4-e2e-devops-spn)

      - script: |
          az account set -s $AZURE_SUBSCRIPTION_ID
        displayName: Setup (Azure)

      - script: |
          wget -nv https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/$(OpenShiftCLIVersion)/openshift-client-linux-$(OpenShiftCLIVersion).tar.gz
          tar xf openshift-client-linux-$(OpenShiftCLIVersion).tar.gz
          az 
          ./test/scripts/role-definition.sh ./oc
        displayName: Execute Tests
        target: container
