trigger: none
pr: none

resources:
  pipelines:
    - pipeline: e2e
      source: \Public Cloud ARO pipelines\CI\CI
      trigger: true
  containers:
    - container: container
      image: registry.access.redhat.com/ubi8/toolbox:8.8
      options: --user=0 --privileged -v /dev/shm:/dev/shm --device /dev/net/tun --name vpn

# Azure DevOps Pipeline running e2e tests
variables:
  - template: vars.yml

# Run the test suite and collect must-gather
jobs:
  - job: E2E
    timeoutInMinutes: 180
    variables:
      ARO_PODMAN_SOCKET: "tcp://localhost:8888"
      ARO_SELENIUM_HOSTNAME: "localhost"
    pool:
      name: 1es-aro-ci-pool
    steps:
      - template: ./templates/template-checkout.yml

      - script: |
          set -xe
          sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
          sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
          sudo dnf install -y https://packages.microsoft.com/config/rhel/8/packages-microsoft-prod.rpm
          sudo dnf install -y openvpn make podman jq conmon containers-common crun iptables netavark nftables slirp4netns azure-cli
        displayName: Setup (Container)
        target: container

      - script: |
          set -e
    
          trap 'rm -f devops-spn.json' EXIT
          base64 -d >devops-spn.json <<<$(aro-v4-e2e-devops-spn)
    
          az login --service-principal -u "$(jq -r .clientId <devops-spn.json)" -p "$(jq -r .clientSecret <devops-spn.json)" -t "$(jq -r .tenantId <devops-spn.json)" --allow-no-subscriptions >/dev/null
        displayName: üóù AZ Login
        target: container

      - script: |
          az account set -s $AZURE_SUBSCRIPTION_ID
        displayName: Setup (Azure)
        target: container

      - script: |
          wget -nv https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/$(OpenShiftCLIVersion)/openshift-client-linux-$(OpenShiftCLIVersion).tar.gz
          tar xf openshift-client-linux-$(OpenShiftCLIVersion).tar.gz
          ./test/scripts/role-definition.sh ./oc `which az`
        displayName: Execute Tests
        target: container
