trigger: none
pr: none

resources:
  pipelines:
  - pipeline: e2e
    source: CI
    trigger: true

# Azure DevOps Pipeline running e2e tests
variables:
- template: vars.yml
jobs:
- job: E2E
  timeoutInMinutes: 180
  pool:
    name: ARO-CI
  steps:
  - template: ./templates/template-checkout.yml
  - template: ./templates/template-az-cli-login.yml
    parameters:
      azureDevOpsJSONSPN: $(aro-v4-e2e-devops-spn)
  - script: |
      export SECRET_SA_ACCOUNT_NAME=$(SECRET_SA_ACCOUNT_NAME)
      make secrets
      . secrets/env
      echo "##vso[task.setvariable variable=RP_MODE]$RP_MODE"
    displayName: ðŸ”‘ Downloading certificates and secrets from storage account
    name: setEnv
  - template: ./templates/template-push-images-to-acr.yml
    parameters:
      rpImageACR: $(RP_IMAGE_ACR)
      buildCommand: publish-image-aro
  - script: | # instead of running e2e, just make a big file to make sure we don't have artifact size limits
      touch dummy.txt
      fallocate -l 400M dummy.txt
  - template: ./templates/template-publish-artifacts.yml
  - template: ./templates/template-az-cli-logout.yml

