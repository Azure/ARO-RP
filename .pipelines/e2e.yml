trigger: none
pr: none

resources:
  pipelines:
  - pipeline: e2e
    source: CI
    trigger: true

# Azure DevOps Pipeline running e2e tests
variables:
- template: vars.yml
jobs:
- job: E2E
  timeoutInMinutes: 180
  pool:
    name: ARO-CI
    demands: go-1.16
  steps:
  - template: ./templates/template-checkout.yml
  - template: ./templates/template-az-cli-login.yml
    parameters:
      azureDevOpsJSONSPN: $(aro-v4-e2e-devops-spn)
  - script: |
      az account set -s $AZURE_SUBSCRIPTION_ID
      export SECRET_SA_ACCOUNT_NAME=$(SECRET_SA_ACCOUNT_NAME)
      make secrets
      . secrets/env
      echo "##vso[task.setvariable variable=RP_MODE]$RP_MODE"
    displayName: ðŸ”‘ Downloading certificates and secrets from storage account
    name: setEnv
  - template: ./templates/template-push-images-to-acr.yml
    parameters:
      rpImageACR: $(RP_IMAGE_ACR)
      buildCommand: publish-image-aro
  - script: |
      set -e
      set -o pipefail

      . secrets/env

      az account set -s $AZURE_SUBSCRIPTION_ID

      set -x
      . ./hack/e2e/run-rp-and-e2e.sh

      deploy_e2e_db

      run_rp
      validate_rp_running
      register_sub

      export CI=true
      if make test-e2e;
      then
        echo "E2E Pass, Skipping must-gather"
        echo "##vso[task.setvariable variable=mustGather]No"
      else
        echo "E2E Failed, need must-gather"
        echo "##vso[task.setvariable variable=mustGather]Yes"
      fi
  - script: |
      set -e
      wget https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.9.8/openshift-client-linux-4.9.8.tar.gz
      tar xf openshift-client-linux-4.9.8.tar.gz

      export LOCATION=eastus
      export CLUSTER="v4-e2e-V$BUILD_BUILDID-$LOCATION"
      export DATABASE_NAME="v4-e2e-V$BUILD_BUILDID-$LOCATION"
      . ./secrets/env
      . ./hack/e2e/run-rp-and-e2e.sh
      make admin.kubeconfig
      export KUBECONFIG=admin.kubeconfig
      ./oc adm must-gather
      tar cf must-gather-$CLUSTER.tar.gz must-gather.local.*
      kill_rp 
      clean_e2e_db
    condition: eq(variables['mustGather'], 'Yes')
    displayName: Collect Must Gather
  - publish: /home/cloud-user/must-gather.tar.gz
    artifact: must-gather
  - template: ./templates/template-az-cli-logout.yml
