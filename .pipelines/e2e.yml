trigger: none
pr: none

resources:
  pipelines:
  - pipeline: e2e
    source: CI
    trigger: true

# Azure DevOps Pipeline running e2e tests
variables:
- template: vars.yml

# Run the test suite and collect must-gather
jobs:
- job: E2E
  timeoutInMinutes: 180
  pool:
    name: ARO-CI
    demands: go-1.17
  steps:
  - template: ./templates/template-checkout.yml

  - template: ./templates/template-az-cli-login.yml
    parameters:
      azureDevOpsJSONSPN: $(aro-v4-e2e-devops-spn)

  - template: ./templates/template-push-images-to-acr.yml
    parameters:
      rpImageACR: $(RP_IMAGE_ACR)
      buildCommand: publish-image-aro

  - script: |
      echo $(SECRET_SA_ACCOUNT_NAME)
    displayName: test-var-SECRET_SA_ACCOUNT_NAME

  - task: Docker@2
    displayName: Build E2E Image
    inputs:
      repository: e2e
      tags: $(Build.BuildId)
      arguments: '--platform=linux/amd64 --no-cache --build-arg AzureDevOpsJSONSPN=$(aro-v4-e2e-devops-spn) --build-arg AZURE_SUBSCRIPTION_ID=$(AZURE_SUBSCRIPTION_ID) --build-arg SECRET_SA_ACCOUNT_NAME=$(SECRET_SA_ACCOUNT_NAME) --build-arg LOCATION=$(LOCATION)'
      command: build
      Dockerfile: Dockerfile.e2e

  - script: |
      docker run --platform=linux/amd64 --name e2e_container_$(Build.BuildId) -t --rm e2e:$(Build.BuildId)
    displayName: Execute Tests

  - script: |
      docker stop e2e_container_$(Build.BuildId) && docker rm e2e_container_$(Build.BuildId) || true
      docker rmi e2e:$(Build.BuildId) || true
    displayName: Clean E2E container and Images
    condition: always()

  - task: PublishTestResults@2
    displayName: ðŸ“Š Publish tests results
    inputs:
      testResultsFiles: $(System.DefaultWorkingDirectory)/**/e2e-report.xml
    condition: succeededOrFailed()

  - task: CopyFiles@2
    condition: succeededOrFailed()
    inputs:
      contents: $(Build.SourcesDirectory)/*.png
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: Screenshots

  - template: ./templates/template-az-cli-logout.yml
