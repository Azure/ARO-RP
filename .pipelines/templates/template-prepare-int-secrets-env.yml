parameters:
  parentDomainName: ""
  parentDomainRg: ""
  pullSecret: ""
  rgPrefix: ""
  workingDirectory: ""
  location: ""
  mdmFrontendUrl: ""
  mdmMetricNamespace: ""
  mdmMonitoringAccount: ""
  rpImage: ""
  rpImagePullJSONSPN: ""
  azureFpClientId: ""
  sshPublicKey: ""
  encryptionKey: ""
  azureDevOpsJSONSPN: ""
  mdsdNamespace: ""
  mdsdMonitoringAccount: ""
  mdsdMonitoringEnviroment: ""
  mdsdConfigVersion: ""
steps:
  - script: |
      cd ${{ parameters.workingDirectory }}

      set -eu

      echo ${{ parameters.azureDevOpsJSONSPN }} | base64 -d > devops-spn.json
      DEVOPS_CLIENT_ID=$(cat devops-spn.json | jq -r '.clientId')
      PARENT_DOMAIN_NAME=${{ parameters.parentDomainName }}
      PARENT_DOMAIN_RESOURCEGROUP=${{ parameters.parentDomainRg }}
      PULL_SECRET='${{ parameters.pullSecret }}'
      AZURE_FP_CLIENT_ID=${{ parameters.azureFpClientId }}
      RESOURCEGROUP_PREFIX=${{ parameters.rgPrefix }}
      LOCATION=${{ parameters.location }}
      COSMOSDB_ACCOUNT=${{ parameters.databaseAccountName }}
      MDM_FRONTEND=${{ parameters.mdmFrontendUrl }}
      MDM_NAMESPACE=${{ parameters.mdmMetricNamespace }}
      MDM_ACCOUNT=${{ parameters.mdmMonitoringAccount }}
      MDSD_NAMESPACE=${{ parameters.mdsdNamespace }}
      MDSD_ACCOUNT=${{ parameters.mdsdMonitoringAccount }}
      MDSD_ENVIROMENT=${{ parameters.mdsdMonitoringEnviroment }}
      MDSD_CONFIG_VERSION=${{ parameters.mdsdConfigVersion }}
      RP_IMAGE=${{ parameters.rpImage }}
      echo ${{ parameters.rpImagePullJSONSPN }} | base64 -d -w 0 > pull-spn.json
      pull_spn_client_id=$(cat devops-spn.json | jq -r '.clientId')
      pull_spn_client_secret=$(cat devops-spn.json | jq -r '.clientSecret')
      RP_IMAGE_AUTH=$(echo "$pull_spn_client_id:$pull_spn_client_secret" | base64 -w 0)
      ENCRYPTION_KEY=${{ parameters.encryptionKey }}
      RESOURCEGROUP="$RESOURCEGROUP_PREFIX-$LOCATION"
      COSMOSDB_ACCOUNT="$RESOURCEGROUP"
      KEYVAULT_PREFIX="$RESOURCEGROUP"

      cat >secrets/env <<EOF
      export RESOURCEGROUP='$RESOURCEGROUP'
      export LOCATION='$LOCATION'
      DEVOPS_CLIENT_ID="$DEVOPS_CLIENT_ID"
      DOMAIN_NAME='aro-int'
      KEYVAULT_PREFIX='$KEYVAULT_PREFIX'
      PARENT_DOMAIN_NAME='$PARENT_DOMAIN_NAME'
      PARENT_DOMAIN_RESOURCEGROUP='$PARENT_DOMAIN_RESOURCEGROUP'
      ENCRYPTION_KEY='$ENCRYPTION_KEY'
      COSMOSDB_ACCOUNT="$COSMOSDB_ACCOUNT"
      AZURE_FP_CLIENT_ID="$AZURE_FP_CLIENT_ID"
      KEYVAULT_PREFIX="$KEYVAULT_PREFIX"
      MDM_FRONTEND="$MDM_FRONTEND"
      MDM_NAMESPACE="$MDM_NAMESPACE"
      MDM_ACCOUNT="$MDM_ACCOUNT"
      MDM_CERT_VAULT_ID="https://aro-monitoring-int.vault.azure.net/secrets/RP-Metrics"
      PULL_SECRET='$PULL_SECRET'
      RP_IMAGE="$RP_IMAGE"
      RP_IMAGE_AUTH="$RP_IMAGE_AUTH"
      MDSD_NAMESPACE="$MDSD_NAMESPACE"
      MDSD_ACCOUNT="$MDSD_ACCOUNT"
      MDSD_ENVIROMENT="$MDSD_ENVIROMENT"
      MDSD_CONFIG_VERSION="$MDSD_CONFIG_VERSION"
      MDSD_CERT_VAULT_ID="https://aro-monitoring-int.vault.azure.net/secrets/RP-Logging"
      EOF

      . secrets/env
    displayName: "ğŸŒ± Prepare secrets env"
