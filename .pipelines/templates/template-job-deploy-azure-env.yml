# Azure DevOps Job deploying rp
parameters:
  aroVersionStorageAccount: ''
  azureDevOpsE2EJSONSPN: ''
  azureDevOpsJSONSPN: ''
  billingE2EPipelineName: ''
  billingE2EBranchName: ''
  configFileName: ''
  e2eSubscription: ''
  environment: ''
  fullDeploy: ''
  locations: []
  rpMode: ''
  vsoProjectID: ''
  vsoConfigPipelineID: ''
  vsoConfigBuildID: ''
  vsoDeployerPipelineID: ''
  vsoDeployerBuildID: ''

jobs:
- ${{ each location in  parameters.locations }}:
  - deployment: Deploy_${{ location }}
    pool:
      name: ARO-CI
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: specific
              project: ${{ parameters.vsoProjectID }}
              pipeline: ${{ parameters.vsoConfigPipelineID }}
              ${{ if eq(parameters.vsoConfigBuildID, 'latest') }}:
                buildVersionToDownload: latestFromBranch
                branchName: refs/heads/master
              ${{ if ne(parameters.vsoConfigBuildID, 'latest') }}:
                buildVersionToDownload: specific
                buildId: ${{ parameters.vsoConfigBuildID }}
              downloadType: specific
              downloadPath: $(System.ArtifactsDirectory)/config
            displayName: Download Config
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: specific
              project: ${{ parameters.vsoProjectID }}
              pipeline: ${{ parameters.vsoDeployerPipelineID }}
              ${{ if eq(parameters.vsoDeployerBuildID, 'latest') }}:
                buildVersionToDownload: latestFromBranch
                branchName: refs/heads/master
              ${{ if ne(parameters.vsoDeployerBuildID, 'latest') }}:
                buildVersionToDownload: specific
                buildId: ${{ parameters.vsoDeployerBuildID }}
              downloadType: specific
              downloadPath: $(System.ArtifactsDirectory)/deployer
            displayName: Download Deployer
          - template: ./template-deploy-azure-env.yml
            parameters:
              configDirectory: $(System.ArtifactsDirectory)/config/drop/deploy
              deployerDirectory: $(System.ArtifactsDirectory)/deployer/drop
              configFileName: ${{ parameters.configFileName }}
              location: ${{ location }}
              azureDevOpsJSONSPN: ${{ parameters.azureDevOpsJSONSPN }}
              fullDeploy: ${{ parameters.fullDeploy }}
  - template: ./template-rp-and-billing-e2e.yml
    parameters:
      e2e_subscription: ${{ parameters.e2eSubscription }}
      aro_v4_e2e_devops_spn: ${{ parameters.azureDevOpsE2EJSONSPN }}
      billing_e2e_pipeline_name: ${{ parameters.billingE2EPipelineName }}
      billing_e2e_branch_name: ${{ parameters.billingE2EBranchName }}
      location: ${{ location }}
      rpMode: ${{ parameters.rpMode }}
