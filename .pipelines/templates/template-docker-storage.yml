# Redirect Docker data-root to /mnt/storage/docker.
#
# The CI pool nodes have a small root partition (~73GB) that fills up during
# Go module downloads and image builds (~15GB). /mnt/storage is a separate
# mounted disk with more space.
#
# This template reconfigures the Docker daemon to store all data (images,
# containers, build cache, layers) on /mnt/storage instead of /var/lib/docker.
#
# Must be called AFTER Docker is installed/available but BEFORE any builds.
# If /mnt/storage is not a mountpoint, the step is skipped and Docker uses
# its default location.
#
# Usage:
#   - template: ./templates/template-docker-storage.yml

steps:
  - bash: |
      set -e
      STORAGE_DIR="/mnt/storage/docker"

      if ! mountpoint -q /mnt/storage 2>/dev/null; then
        echo "/mnt/storage is not a mounted filesystem â€” skipping Docker data-root redirect"
        echo "Docker will use default data-root: $(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo '/var/lib/docker')"
        exit 0
      fi

      echo "=== Redirecting Docker data-root to ${STORAGE_DIR} ==="
      echo "--- /mnt/storage disk usage before ---"
      df -h /mnt/storage

      # Create the target directory
      sudo mkdir -p "${STORAGE_DIR}"

      # Configure Docker daemon to use the new data-root
      # Merge with existing daemon.json if present, otherwise create new
      DAEMON_JSON="/etc/docker/daemon.json"
      if [ -f "${DAEMON_JSON}" ]; then
        echo "Existing daemon.json found, merging data-root setting:"
        cat "${DAEMON_JSON}"
        # Use jq if available, otherwise overwrite
        if command -v jq &>/dev/null; then
          sudo cp "${DAEMON_JSON}" "${DAEMON_JSON}.bak"
          jq --arg dr "${STORAGE_DIR}" '. + {"data-root": $dr}' "${DAEMON_JSON}.bak" | sudo tee "${DAEMON_JSON}" > /dev/null
        else
          echo "{\"data-root\": \"${STORAGE_DIR}\"}" | sudo tee "${DAEMON_JSON}" > /dev/null
        fi
      else
        echo "{\"data-root\": \"${STORAGE_DIR}\"}" | sudo tee "${DAEMON_JSON}" > /dev/null
      fi
      echo "Updated daemon.json:"
      cat "${DAEMON_JSON}"

      # Restart Docker to apply the new data-root
      echo "Restarting Docker daemon..."
      sudo systemctl restart docker
      sudo systemctl is-active docker

      # Verify the change took effect
      ACTUAL_ROOT=$(docker info --format '{{.DockerRootDir}}')
      echo "Docker data-root is now: ${ACTUAL_ROOT}"
      if [ "${ACTUAL_ROOT}" != "${STORAGE_DIR}" ]; then
        echo "ERROR: Docker data-root did not change to ${STORAGE_DIR}"
        exit 1
      fi

      echo "--- /mnt/storage disk usage after ---"
      df -h /mnt/storage
      echo "=== Docker data-root redirect complete ==="
    displayName: "ðŸ“‚ Redirect Docker storage to /mnt/storage"
