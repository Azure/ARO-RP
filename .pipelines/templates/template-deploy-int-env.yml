parameters:
  workingDirectory: ""
  sshPublicKey: ""
  pullSecret: ""
  location: ""
  rgPrefix: ""
  parentDomainName: ""
  parentDomainRg: ""
  azureDevOpsJSONSPN: ""
  domainName: ""
steps:
  - script: |
      set -eu
      cd ${{ parameters.workingDirectory }}

      echo ${{ parameters.azureDevOpsJSONSPN }} | base64 -d > devops-spn.json
      export DEVOPS_CLIENT_ID=$(cat devops-spn.json | jq -r '.clientId')
      RESOURCEGROUP_PREFIX=${{ parameters.rgPrefix }}
      export LOCATION=${{ parameters.location }}
      export RESOURCEGROUP="$RESOURCEGROUP_PREFIX-$LOCATION"
      export KEYVAULT_PREFIX="$RESOURCEGROUP"
      export DOMAIN_NAME=${{ parameters.domainName }}
      export PARENT_DOMAIN_NAME=${{ parameters.parentDomainName }}
      export PARENT_DOMAIN_RESOURCEGROUP=${{ parameters.parentDomainRg }}
      
      source ./hack/deploy/int-runtime-secrets-and-auth.sh

      echo "########## Creating RG $RESOURCEGROUP in $LOCATION ##########"
      az group create -g "$RESOURCEGROUP" -l "$LOCATION" >/dev/null
      
      export RP_PARAMETERS_FILE="secrets/parameters.json"
      aro deploy

      upload-kv-secrets
      add-ns-record-parent-dns-zone
    displayName: "ðŸš€ Buildout INT env"
