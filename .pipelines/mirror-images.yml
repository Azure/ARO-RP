trigger: none
pr: none

jobs:
- job: Mirror_images
  timeoutInMinutes: 180
  pool:
    name: ARO-CI

  steps:
  - template: ./templates/template-az-cli-login.yml
    parameters:
      azureDevOpsJSONSPN: $(aro-v4-ci-devops-spn)
  - script: |
      set -e

      trap 'set +e; for c in $(docker ps -aq); do docker rm -f $c; done; docker image prune -af; rm -rf ~/.docker/config.json' EXIT

      export DST_AUTH=$(acr-push-auth)
      export DST_ACR_NAME=$(dst-acr-name)
      export SRC_AUTH_GENEVA=$(acr-geneva-pull-auth)
      export SRC_AUTH_QUAY=$(quay-pull-auth)
      export SRC_AUTH_REDHAT=$(redhat-pull-auth)

      az acr login --name arointsvc

      docker run \
        --rm \
        -e DST_AUTH \
        -e DST_ACR_NAME \
        -e SRC_AUTH_GENEVA \
        -e SRC_AUTH_QUAY \
        arointsvc.azurecr.io/aro:latest mirror
    displayName: ðŸš€ Fetch and mirror images
  - template: ./templates/template-az-cli-logout.yml
