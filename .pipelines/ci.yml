# Azure DevOps Pipeline running CI

trigger:
  branches:
    include:
      - master
      - loki/pipeline-swarm
  paths:
    exclude:
      - docs/*
  tags:
    include:
      - v2*

pr:
  branches:
    include:
      - loki/pipeline-swarm
  paths:
    exclude:
      - docs/*

variables:
  - template: vars.yml

resources:
  containers:
    - container: golang
      image: registry.access.redhat.com/ubi8/go-toolset:1.21.11-1.1720406008
      options: --user=0

stages:
- stage: NEW_HOTNESS
  jobs:
    - job: Build_Lint_Test_RP_And_Portal
      pool:
        name: 1es-aro-ci-pool
      steps:
        - template: ./templates/template-checkout.yml
        - script: |
            set -xe
            export NO_CACHE=true
            make ci-rp

    - job: Build_and_Test_Az_ARO_Extension
      pool:
        name: 1es-aro-ci-pool
      steps:
        - template: ./templates/template-checkout.yml
        - script: |
            set -xe
            export NO_CACHE=true
            make azext-aro

    - job: Lint_Az_ARO_Extension
      pool:
        name: 1es-aro-ci-pool
      steps:
        - template: ./templates/template-checkout.yml
        - script: |
            set -xe
            make test-python

- stage: Golang_Code_Generation
  jobs:
    - job: Run_Golang_Code_Generate
      displayName: "⚙️ Run Golang code generate"
      pool:
        name: 1es-aro-ci-pool
      container: golang
      variables:
        GOCACHE: /tmp/gocache # Set the Go build cache to a writable directory
      steps:
        - template: ./templates/template-checkout.yml
        - script: |
            set -xe
            make generate
            [[ -z "$(git status -s)" ]]
          displayName: "Run Golang Code Generate"
