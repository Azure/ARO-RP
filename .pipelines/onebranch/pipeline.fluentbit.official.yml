# Fluentbit OneBranch Official Build Pipeline

trigger:
  branches:
    include:
      - master
  paths:
    include:
      - Dockerfile.fluentbit
      - .pipelines/onebranch/pipeline.fluentbit.official.yml
      - .pipelines/onebranch/templates/template-build-fluentbit.yml

pr: none

parameters:
  - name: FLUENTBIT_VERSION
    displayName: 'Fluent Bit Version'
    type: string
    default: '2.1.10'
  - name: MARINER_VERSION
    displayName: 'Azure Linux (Mariner) Version'
    type: string
    default: '20250701'

variables:
  - name: LinuxContainerImage
    value: "mcr.microsoft.com/onebranch/azurelinux/build:3.0"
  - name: BUILD_TAG
    value: '${{ parameters.FLUENTBIT_VERSION }}-cm${{ parameters.MARINER_VERSION }}'

resources:
  repositories:
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates
  parameters:
    featureFlags:
      LinuxHostVersion:
        Network: KS3
    globalSdl:
      policheck:
        break: true

    stages:
      - stage: BuildFluentbitImage
        displayName: 'Build Fluentbit Container Image'
        jobs:
          - job: BuildImage
            displayName: 'Build and Package Fluentbit Image'
            pool:
              type: docker
              os: Linux
            variables:
              ob_git_checkout: true
              ob_outputDirectory: '$(Build.ArtifactStagingDirectory)/image'
            steps:
              - task: onebranch.pipeline.imagebuildinfo@1
                displayName: 'Build Fluentbit Docker Image'
                inputs:
                  repositoryName: fluentbit
                  dockerFileRelPath: Dockerfile.fluentbit
                  dockerFileContextPath: .
                  enable_network: true
                  enable_isolated_acr_push: false
                  build_tag: $(BUILD_TAG)
                  saveImageToPath: $(ob_outputDirectory)/image.tar
                  buildkit: 1
                  enable_service_tree_acr_path: false
                  arguments: --build-arg VERSION=${{ parameters.FLUENTBIT_VERSION }} --build-arg MARINER_VERSION=${{ parameters.MARINER_VERSION }}

              - task: Bash@3
                displayName: 'Create Image Metadata'
                inputs:
                  targetType: 'inline'
                  script: |
                    set -euo pipefail

                    echo "Creating image metadata..."
                    cat > $(ob_outputDirectory)/image-metadata.json << EOF
                    {
                      "build_tag": "$(BUILD_TAG)",
                      "fluentbit_version": "${{ parameters.FLUENTBIT_VERSION }}",
                      "mariner_version": "${{ parameters.MARINER_VERSION }}",
                      "build_id": "$(Build.BuildId)",
                      "build_number": "$(Build.BuildNumber)",
                      "source_version": "$(Build.SourceVersion)",
                      "source_branch": "$(Build.SourceBranchName)",
                      "repository": "fluentbit",
                      "dockerfile": "Dockerfile.fluentbit"
                    }
                    EOF

                    echo "Image metadata created:"
                    cat $(ob_outputDirectory)/image-metadata.json

                    echo ""
                    echo "Artifact contents:"
                    ls -lh $(ob_outputDirectory)/

              - task: PublishPipelineArtifact@1
                displayName: 'Publish Fluentbit Image Artifact'
                inputs:
                  targetPath: '$(ob_outputDirectory)'
                  artifact: 'fluentbit-image'
                  publishLocation: 'pipeline'
