# Azure DevOps Pipeline deploying the int environment
trigger: none
pr: none

variables:
  - template: vars.yml

jobs:
  - job: "Deploy_int_env_or_build"
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - template: ./templates/template-setup-golang-env.yml
        parameters:
          gobin: ${{ variables.GOBIN }}
          gopath: ${{ variables.GOPATH }}
          goroot: ${{ variables.GOROOT }}
          modulePath: ${{ variables.modulePath }}
      - template: ./templates/template-setup-azure-tools.yml
        parameters:
          workingDirectory: ${{ variables.modulePath }}
      - template: ./templates/template-az-cli-login.yml
        parameters:
          workingDirectory: ${{ variables.modulePath }}
          azureDevOpsJSONSPN: $(aro-v4-ci-devops-spn)
      - template: ./templates/template-pull-pem-from-kv.yml
        parameters:
          kvName: "ARO-INT-RP"
          certName: "RP-SP-Login"
          outputPath: ${{ variables.modulePath }}/secrets/fp-client-cert
      - template: ./templates/template-pull-pem-from-kv.yml
        parameters:
          kvName: "ARO-INT-RP"
          certName: "int-ssl"
          outputPath: ${{ variables.modulePath }}/secrets/ssl-cert
      - template: ./templates/template-prepare-int-secrets-env.yml
        parameters:
          domainName: "aro-int"
          parentDomainName: "dev.aroapp.io"
          azureFpClientId: $(aro-int-rp-object-id)
          location: "eastus"
          rgPrefix: "aro-int"
          mdmFrontendUrl: "https://int2.int.microsoftmetrics.com/"
          rpMdmMetricNamespace: "ARO-RP"
          rpMdmMonitoringAccount: "AzureRedHatOpenShift"
          rpMdmCertificateVaultId: "https://aro-monitoring-int.vault.azure.net/secrets/RP-Metrics"
          clusterMdmMetricNamespace: "ARO-Clusters"
          clusterMdmMonitoringAccount: "AzureRedHatOpenShiftClusters"
          rpImage: $(RP-IMAGE)
          rpImagePullJSONSPN: $(aro-v4-int-image-pull-spn)
          workingDirectory: ${{ variables.modulePath }}
          encryptionKey: $(int-encryption-key)
          mdsdNamespace: "ARORPLogs"
          mdsdMonitoringAccount: "ARORPLogs"
          mdsdMonitoringEnviroment: "Test"
          mdsdConfigVersion: $(MDSD-CONFIG-VERSION)
          rpMdsdCertificateVaultId: "https://aro-monitoring-int.vault.azure.net/secrets/RP-Logging"
          vmssDomainNameLabel: "aro-int"
          vmssName: "int"
          rpMode: "int"
      - template: ./templates/template-deploy-int-env.yml
        parameters:
          workingDirectory: ${{ variables.modulePath }}
          azureDevOpsJSONSPN: $(aro-v4-ci-devops-spn)
          pullSecret: $(aro-pullsecret)
          sshPublicKey: $(int-ssh-public-key)
          domainName: "aro-int"
          parentDomainName: "dev.aroapp.io"
          parentDomainRg: "global-infra"
          location: "eastus"
          rgPrefix: "aro-int"
