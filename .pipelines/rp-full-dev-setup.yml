trigger: none
pr: none

# Parameters
# ---------
parameters:
  - template: ./rp-dev/rp-dev-params.yml

resources:
  containers:
    - container: container
      image: registry.access.redhat.com/ubi8/toolbox:8.10
      options: --user=0 --privileged -v /dev/shm:/dev/shm --device /dev/net/tun --name rp-dev-container # Root (and full sysetme) user privileges, shared memory between host and container, and access to the TUN device for network tunneling

# Variables
# ---------

variables:
  - template: ./rp-dev/rp-dev-vars.yml

jobs:
  - job: Full_RP_dev_setup_deployment
    displayName: Deploy Full RP Dev
    timeoutInMinutes: 180
    pool:
      name: 1es-aro-ci-pool

    steps:
# setup
      # 1) Checkout repo
      - template: ./templates/template-checkout.yml
      
      # 2) Login to Azure with az CLI
      - template: ./templates/template-az-cli-login.yml # does it have az CLI alraedy?
        parameters:
          azureDevOpsJSONSPN: ${{ parameters.azureJson }}
      
      # 3) Download shard RP secrets
      - template: ./templates/rp-dev/template-download-secrets.yml
        parameters:
          secretSA: ${{ parameters.secretSA }}
      
      # 4) Generate RP Dev configuration file
      - template: ./templates/rp-dev/template-generate-rp-dev-config.yml
        parameters:
          location: ${{ parameters.location }}
          resourceGroup: ${{ parameters.resourceGroup }}
          databaseAccountName: ${{ parameters.databaseAccountName }}
          keyvaultPrefix: ${{ parameters.keyvaultPrefix }}
          aroImage: ${{ parameters.aroImage }}
        
      # 5) Semi deploy ...
      - script: make deploy # use different target which will succeed and won't fail
        name: semi-deploy-aro-rp-dev
        displayName: ⚙️ Run pre-deplyments tasks prior to AKS
        condition: ${{ variables['is-release'] }}
      
      # 6) Deploy VPN Gateway
      - script: source ./hack/devtools/deploy-shared-env.sh && deploy_vpn_for_dedicated_rp
        name: deploy-vpn-gateway
        displayName: ⚙️ Deploy VPN Gateway
      
      # 7) Deploy AKS
      - script: source ./hack/devtools/deploy-shared-env.sh && deploy_aks_dev
        name: deploy-aks-dev
        displayName: ⚙️ Deploy AKS

      # 8) Install Hive
      - template: ./templates/rp-dev/template-install-hive.yml
        parameters:
          location: ${{ parameters.location }}
      
      # 9) Login to ACR
      - template: ./templates/rp-dev/template-acr-login.yml
        parameters:
          dst_acr_name: ${{ parameters.dst_acr_name }}
      
      # 10) Mirror OCP images to ACR
      - template: ./templates/rp-dev/template-mirror-ocp-images.yml
        parameters:
          dst_acr_name: ${{ parameters.dst_acr_name }}
          mirrorTag: ${{ parameters.ocpVersionTag }}

      # 11) Push ARO and Fluenbit to ACR
      - template: ./templates/rp-dev/template-push-aro-fluenbit-to-acr.yml
        parameters:
          dst_acr_name: ${{ parameters.dst_acr_name }}
      
      # 12) Create DNS domain
      - template: ./templates/rp-dev/template-dns-domain-and-certificate-keyvault.yml
      
      # 13) Delete old RP VMSS
      - template: ./templates/rp-dev/template-delete-vmss.yml
        parameters:
          resourceGroup: ${{ parameters.resourceGroup }}
          vmssName: rp-vmss-${{ parameters.gitCommit }}
      
      # 14) Delete old Gateway VMSS
      - template: ./templates/rp-dev/template-delete-vmss.yml
        parameters:
          resourceGroup: $(AZURE_UNIQUE_PREFIX)-gwy-${{ parameters.location }}
          vmssName: gateway-vmss-${{ parameters.gitCommit }}
      
      # 15) Fully delpoy RP
      - script: make deploy
        name: full-deploy-aro-rp-dev
        displayName: ⚙️ Fully deploy ARO RP Setup
      
      # 16) Create SA and Role assignment
      - script: |
          source ./hack/devtools/deploy-shared-env.sh
          deploy_oic_for_dedicated_rp
        name: create-sa-role
        displayName: ⚙️ Create storage account and role assignment
## few more steps would be added

# cleanup
      - template: ./templates/template-az-cli-logout.yml
